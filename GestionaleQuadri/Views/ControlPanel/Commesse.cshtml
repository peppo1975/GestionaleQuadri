@{
    ViewData["Title"] = "Commesse";
    var ViewCommessa = ViewData["ViewCommessa"] as ViewCommessa;
}
@* https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_collapsible_animate *@
<style>
    .collapsible {
        /* background-color: #777; */
        /*        background-color: #3F4D67;
        color: white;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
        border-radius: 5px;*/
    }

        .actives, .collapsible:hover {
            /* background-color: #555;  */
            background-color: forestgreen;
        }

    .content {
        padding: 0 18px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
        background-color: #f1f1f1;
    }
</style>
<style>
    /* The Modal (background) */
    .modals {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-contents {
        position: relative;
        background-color: #fefefe;
        margin: auto;
        padding: 0;
        border: 1px solid #888;
        /* width: 80%; */
        width: 82%;
        left: 131px;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        -webkit-animation-name: animatetop;
        -webkit-animation-duration: 0.4s;
        animation-name: animatetop;
        animation-duration: 0.4s
    }

    /* Add Animation */ @@-webkit-keyframes animatetop {
        from {
            top: 0px;
            opacity: 0
        }

        to {
            top: 0;
            opacity: 1
        }
    }

    @@keyframes animatetop {
        from {
            top: 0px;
            opacity: 0
        }

        to {
            top: 0;
            opacity: 1
        }
    }

    /* The Close Button */
    .close {
        color: white;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

    .modal-header {
        padding: 2px 16px;
        background-color: #5cb85c;
        color: white;
    }

    .modal-body {
        padding: 2px 16px;
    }

    .modal-footer {
        padding: 2px 16px;
        background-color: #5cb85c;
        color: white;
    }
</style>
<div class="pc-content">
    <!-- [ breadcrumb ] start -->
    <div class="page-header">
        <div class="page-block">
            <div class="page-header-title">
                <h5 class="mb-0 font-medium">
                    @ViewData["Title"]
                </h5>
            </div>
        </div>
    </div>
    <!-- [ breadcrumb ] end -->
    <!-- [ Main Content ] start -->

    <div class="row">

        @{
            foreach (int a in ViewCommessa.anno)
            {
                <div class="col-md-12 col-xl-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row d-flex align-items-center collapsible">
                                <div class="col-9">
                                    <h3 class="f-w-300 d-flex align-items-center m-b-0 pointer" anno_i="@a">
                                        @a
                                    </h3>
                                </div>

                            </div>
                            <div id="@a" class="content">

                            </div>
                        </div>
                    </div>
                </div>
            }
        }

    </div>
    <!-- [ Main Content ] end -->
</div>
<!-- The Modal -->
<div id="myModal" class="modals">
    <!-- Modal content -->
    <div class="modal-contents">
        <div class="modal-header">
            @*<span class="close">&times;</span>*@
            <h2 id="nome-azienda-modale">Modal Header</h2>
            <button type="button" class="btn-close close" data-bs-dismiss="modals" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modal-body">
            <p>Some text in the Modal Body</p>
            <p>Some other text...</p>
        </div>
        <div class="modal-footer">
            <h3>Modal Footer</h3>
        </div>
    </div>
</div>
<script>
    class Commessa {



        constructor() {
            this.objects();
        }

        objects() {
            this.committente = {
                nome_commessa: "John"
            };
        }

        clearAnno() {
            var infoAzienda = document.getElementsByClassName("info-azienda");
            Object.keys(infoAzienda).forEach((i) => {
                infoAzienda[i].innerHTML = "";
            });
        }

        elencaAziende(anno, result) {
            var id = document.getElementById(anno);
            id.innerHTML = "";
            var ul = document.createElement("ul");
            ul.classList.add("list-group");
            //ul.style.display = "none";
            result.forEach((i) => {
                var li = document.createElement("li");
                li.classList.add("list-group-item");

                var h = document.createElement("h4");
                h.classList.add("pointer");
                h.classList.add("text-green");
                h.classList.add("modal-list");

                h.innerHTML = i.nome_azienda;

                h.setAttribute("anno", anno);
                h.setAttribute("azienda", i.azienda);

                li.appendChild(h);
                ul.appendChild(li);
            });

            id.appendChild(ul);
        }

        avviaModale(modalList) {
            var modal = document.getElementById("myModal");
            var span = document.getElementsByClassName("close")[0];
            var nome_azienda_modale = document.getElementById("nome-azienda-modale");
            var modal_body = document.getElementById("modal-body");
            var numeroRighe = 0;


            Object.keys(modalList).forEach((i) => {
                modalList[i].addEventListener('click', async function () {

                    modal.style.display = "block";
                    let anno = modalList[i].getAttribute("anno");
                    let azienda = modalList[i].getAttribute("azienda");
                    let nome = modalList[i].innerHTML;
                    //nome_azienda_modale.innerHTML = nome + " " + anno;
                    const response = await fetch("/Commesse/AziendeAnnoCommesse/?anno=" + anno + "&azienda=" + azienda);
                    const result = await response.json();

                    modal_body.innerHTML = "";
                    numeroRighe = result.length;
                    nome_azienda_modale.innerHTML = nome + " " + anno + "  (" + numeroRighe + ")";

                    let table = document.createElement("table");
                    let tableThead = document.createElement("thead");
                    let tbody = document.createElement("tbody");

                    table.appendChild(tbody);
                    table.appendChild(tableThead);
                    



                    modal_body.appendChild(table);
                    table.classList.add("table");
                    table.classList.add("table-striped");
                    table.classList.add("table-sm");

                    

                   

                    let titoli = ["offerta n.", "committente", "note", "nome quadro", "ODL", "data apertura", "MRC"];
                    let theadRow = document.createElement("tr");
                    titoli.forEach((j) => {
                        let th = document.createElement("th");
                        th.innerHTML = j;
                        theadRow.appendChild(th);
                    });


                  



                    Object.keys(result).forEach((k) => {
                        let row = document.createElement("tr");
                        titoli.forEach((j) => {
                            let td = document.createElement("td");
                            if (j == titoli[1]) {
                                td.innerHTML = result[k].nome_commessa;
                            }
                            row.appendChild(td)
                        });
                        tbody.appendChild(row);
                    });

                    tableThead.appendChild(theadRow);

                    
                    //table.appendChild(tbody);
                    //modal_body.appendChild(table);
                 

                });

            });

            span.onclick = function () {
                modal.style.display = "none";
            }

            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        }

    }

</script>
<script>
    class Tabella {
        constructor(result, modal_body) {
            this.result = result;
            this.modal_body = modal_body;
            this.crea();
        }


        crea() {
            //let modal_body = document.getElementById("modal-body");
            // modal_body.innerHTML = "";

            //let table =document.createElement("table");
            // table.classList.add("table");
            // table.classList.add("table-striped");
            // table.classList.add("table-sm");

            // let thead = document.createElement("thead");
            // let titoli = ["offerta n.", "committente","note", "nome quadro", "ODL", "data apertura", "MRC"];
            // let theadRow = document.createElement("tr");
            // titoli.forEach((i=>{
            // console.log("qui");
            // });

            // table.appendChild(thead);
            // modal_body.appendChild(table);
        }


    }
</script>
<script>
    //collapse
    let anno = document.getElementsByClassName("collapsible");
    let modalList;
    const comm = new Commessa();

    Object.keys(anno).forEach((i) => {

        anno[i].addEventListener('click', async function (e) {
            var anno = e.srcElement.getAttribute("anno_i");
            //var anno = e.srcElement.innerHTML;
            console.log(anno);
            const response = await fetch("/Commesse/AziendeAnno/" + anno);
            const result = await response.json();
            await comm.elencaAziende(anno, result);


            this.classList.toggle("active");
            var content = this.nextElementSibling;

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            }
            else {
                content.style.maxHeight = content.scrollHeight + "px";
            }

            modalList = document.getElementsByClassName("modal-list");
            await comm.avviaModale(modalList);

        });

    });</script>
